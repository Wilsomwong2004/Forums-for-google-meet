// Global variables for spreadsheet IDs
const FORUMS_SPREADSHEET_ID = "1AC8uSCkMQJrAi-pCgC4WhV00HpHXqgwh_auYQoFPdSU";
const MESSAGES_SPREADSHEET_ID = "1D7IZOZyHuwAOeWJ_JucXwlClUfmt5LeuaeZYGh9fRxo";

function doGet() {  
  return HtmlService.createHtmlOutputFromFile("Index")  
    .setTitle("Forums of Google Meet")  
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);  
}  

function getForums() {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) {
    sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).insertSheet("Forums");
    sheet.appendRow(["ID", "Name", "Description", "CreatedAt", "CreatorName", "Likes", "Dislikes", "Pinned"]);
  }
  var data = sheet.getDataRange().getValues();
  var forums = [];
  for (var i = 1; i < data.length; i++) {
    forums.push({
      id: data[i][0],
      name: data[i][1],
      description: data[i][2],
      createdAt: data[i][3],
      creatorName: data[i][4],
      likes: data[i][5],
      dislikes: data[i][6],
      isPinned: data[i][7] || false,
    });
  }
  return forums;
}

function createForum(name, description) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) {
    sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).insertSheet("Forums");
    sheet.appendRow(["ID", "Name", "Description", "CreatedAt", "CreatorName", "Likes", "Dislikes", "Pinned"]);
  }
  var id = Utilities.getUuid();
  var createdAt = new Date().toISOString();
  var creatorName = Session.getActiveUser().getEmail();
  sheet.appendRow([id, name, description, createdAt, creatorName, 0, 0, false]);
  return {
    id: id,
    name: name,
    description: description,
    createdAt: createdAt,
    creatorName: creatorName,
    likes: 0,
    dislikes: 0,
    pinned: false,
  };
}

function deleteForum(id) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) {
    return false;
  }
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === id) {
      sheet.deleteRow(i + 1);
      return true;
    }
  }
  return false;
}

function getMessages(forumId) {
  var sheet = SpreadsheetApp.openById(MESSAGES_SPREADSHEET_ID).getSheetByName("Messages");
  if (!sheet) {
    return [];
  }
  var data = sheet.getDataRange().getValues();
  var messages = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === forumId) {
      messages.push({
        id: data[i][1],
        text: data[i][2],
        timestamp: data[i][3],
        sender: data[i][4],
        imageUrl: data[i][5],
        likes: data[i][6],
        dislikes: data[i][7],
      });
    }
  }
  return messages;
}

function sendMessage(forumId, text, imageData) {
  var sheet = SpreadsheetApp.openById(MESSAGES_SPREADSHEET_ID).getSheetByName("Messages");
  if (!sheet) {
    sheet = SpreadsheetApp.openById(MESSAGES_SPREADSHEET_ID).insertSheet("Messages");
    sheet.appendRow(["ForumID", "MessageID", "Text", "Timestamp", "Sender", "ImageURL", "Likes", "Dislikes"]);
  }
  var messageId = Utilities.getUuid();
  var timestamp = new Date().toISOString();
  var sender = Session.getActiveUser().getEmail();
  var imageUrl = '';
  
  if (imageData) {
    var blob = Utilities.newBlob(Utilities.base64Decode(imageData), 'image/png', 'image.png');
    var file = DriveApp.createFile(blob);
    imageUrl = file.getUrl();
  }
  
  sheet.appendRow([forumId, messageId, text, timestamp, sender, imageUrl, 0, 0]);
  return { id: messageId, text: text, timestamp: timestamp, sender: sender, imageUrl: imageUrl, likes: 0, dislikes: 0 };
}

function updateLikeCount(forumId, action) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) {
    return false;
  }
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === forumId) {
      var likes = data[i][5];
      var dislikes = data[i][6];
      if (action === "like") {
        likes++;
        if (dislikes > 0) dislikes--;
      } else if (action === "dislike") {
        dislikes++;
        if (likes > 0) likes--;
      }
      sheet.getRange(i + 1, 6).setValue(likes);
      sheet.getRange(i + 1, 7).setValue(dislikes);
      return { likes: likes, dislikes: dislikes };
    }
  }
  return false;
}

function updateLikeDislike(forumId, action) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) return false;
  
  var data = sheet.getDataRange().getValues();
  var userEmail = Session.getActiveUser().getEmail();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === forumId) {
      var likes = JSON.parse(data[i][5] || '{}');
      var dislikes = JSON.parse(data[i][6] || '{}');
      
      if (action === 'like') {
        if (likes[userEmail]) {
          delete likes[userEmail];
        } else {
          likes[userEmail] = true;
          delete dislikes[userEmail];
        }
      } else if (action === 'dislike') {
        if (dislikes[userEmail]) {
          delete dislikes[userEmail];
        } else {
          dislikes[userEmail] = true;
          delete likes[userEmail];
        }
      }
      
      sheet.getRange(i + 1, 6).setValue(JSON.stringify(likes));
      sheet.getRange(i + 1, 7).setValue(JSON.stringify(dislikes));
      
      return {
        likes: Object.keys(likes).length,
        dislikes: Object.keys(dislikes).length
      };
    }
  }
  return false;
}

function togglePinForum(forumId) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) {
    return false;
  }
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === forumId) {
      var pinned = !data[i][7];
      sheet.getRange(i + 1, 8).setValue(pinned);
      return pinned;
    }
  }
  return false;
}

function pinForum(forumId) {
  var sheet = SpreadsheetApp.openById(FORUMS_SPREADSHEET_ID).getSheetByName("Forums");
  if (!sheet) return false;
  
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === forumId) {
      var isPinned = data[i][7] ? false : true;  // Toggle pinned status
      sheet.getRange(i + 1, 8).setValue(isPinned);
      return isPinned;
    }
  }
  return false;
}

function editMessage(messageId, newText) {
  var sheet = SpreadsheetApp.openById(MESSAGES_SPREADSHEET_ID).getSheetByName("Messages");
  if (!sheet) {
    return false;
  }
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === messageId) {
      if (data[i][4] === Session.getActiveUser().getEmail()) {
        sheet.getRange(i + 1, 3).setValue(newText);
        return true;
      }
      return false;
    }
  }
  return false;
}

function deleteMessage(messageId) {
  var sheet = SpreadsheetApp.openById(MESSAGES_SPREADSHEET_ID).getSheetByName("Messages");
  if (!sheet) {
    return false;
  }
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (data[i][1] === messageId) {
      if (data[i][4] === Session.getActiveUser().getEmail()) {
        sheet.deleteRow(i + 1);
        return true;
      }
      return false;
    }
  }
  return false;
}
